{% extends 'adminlayout.html.twig' %}

{% block title %}Service Booking List{% endblock %}

{% block content %}
<style>
    /* Custom CSS Variables for the theme */
    :root {
        --primary-green: #4C763B; /* Main accent green */
        --dark-green: #2e4a28; /* Darker green for contrast */
        --light-green: #e9f0e7; /* Very light green for subtle backgrounds */
        --primary-black: #1a1a1a; /* Main black for text/elements */
        --secondary-black: #2e2e2e; /* Slightly lighter black */
        --primary-white: #ffffff; /* Pure white */
        --off-white: #f8f9fa; /* Off-white for general backgrounds */
        --border-color: #dee2e6; /* Standard border color */
        --card-bg: var(--primary-white);
        --header-bg: var(--dark-green); /* Table header background */
        --table-row-hover: var(--light-green); /* Light green for table row hover */
    }

    /* General Body and Typography */
    body {
        font-family: 'Open Sans', sans-serif;
        background-color: var(--off-white);
        color: var(--secondary-black);
    }
    h3, h5, th {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
    }

    /* Container & Card Styling */
    .container-fluid {
        padding-top: 3rem;
        padding-bottom: 3rem;
    }
    .card {
        border: none;
        border-radius: 1rem; /* Softer rounded corners */
        box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.05); /* Softer shadow */
        background-color: var(--card-bg);
    }
    .card-body {
        padding: 0; /* Remove padding from card body, table handles it */
    }

    /* Table Styling */
    #servicebookingTable {
        min-width: 100%; /* Ensure table fills container */
        border-collapse: separate; /* Allows border-radius on cells if needed */
        border-spacing: 0;
    }
    #servicebookingTable thead tr {
        background-color: var(--header-bg);
        color: var(--primary-white);
        font-size: 0.95rem;
    }
    #servicebookingTable th {
        padding: 1rem 1.25rem;
        border-bottom: none; /* No default border-bottom */
        border-top: none; /* No default border-top */
    }
    #servicebookingTable th:first-child {
        border-top-left-radius: 1rem; /* Rounded corners for first header cell */
    }
    #servicebookingTable th:last-child {
        border-top-right-radius: 1rem; /* Rounded corners for last header cell */
    }
    #servicebookingTable tbody tr {
        transition: background-color 0.2s ease;
    }
    #servicebookingTable tbody tr:hover {
        background-color: var(--table-row-hover);
    }
    #servicebookingTable td {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--border-color); /* Light border between rows */
        font-size: 0.9rem;
        color: var(--secondary-black);
        white-space: normal; /* Allow text to wrap within cells */
        vertical-align: middle;
    }
    #servicebookingTable tbody tr:last-child td {
        border-bottom: none; /* No border-bottom for last row cells */
    }
    #servicebookingTable .text-center {
        text-align: center;
    }

    /* Button Styling */
    .btn-theme-primary {
        background-color: var(--primary-green);
        color: var(--primary-white);
        border: 1px solid var(--primary-green);
        border-radius: 0.375rem; /* Bootstrap's default button radius */
        font-weight: 600;
        transition: all 0.2s ease;
        padding: 0.4rem 0.8rem;
    }
    .btn-theme-primary:hover {
        background-color: var(--dark-green);
        border-color: var(--dark-green);
        color: var(--primary-white);
    }

    .btn-theme-secondary {
        background-color: var(--secondary-black);
        color: var(--primary-white);
        border: 1px solid var(--secondary-black);
        border-radius: 0.375rem;
        font-weight: 600;
        transition: all 0.2s ease;
        padding: 0.4rem 0.8rem;
    }
    .btn-theme-secondary:hover {
        background-color: var(--primary-black);
        border-color: var(--primary-black);
        color: var(--primary-white);
    }

    .btn-delete {
        background-color: #dc3545; /* Red for delete */
        color: var(--primary-white);
        border: 1px solid #dc3545;
        border-radius: 0.375rem;
        font-weight: 600;
        transition: all 0.2s ease;
        padding: 0.4rem 0.8rem;
    }
    .btn-delete:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    /* Modal Styling */
    .modal-content {
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1);
        border: none;
    }
    .modal-header {
        background-color: var(--primary-green);
        color: var(--primary-white);
        border-bottom: none;
        padding: 1.5rem;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
    }
    .modal-header .btn-close {
        filter: invert(1); /* White close button */
        font-size: 0.9rem;
    }
    .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
    }
    .modal-body {
        padding: 2rem;
        color: var(--secondary-black);
    }
    .modal-body ul {
        padding-left: 0;
    }
    .modal-body li {
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    .modal-body strong {
        color: var(--primary-black);
        min-width: 120px; /* Align labels */
        display: inline-block;
    }
    .modal-body .text-muted {
        color: #6c757d !important;
    }

    /* Edit Modal Specific */
    .modal-body #editModalBody {
        text-align: center;
        padding: 3rem;
    }
    .spinner-border {
        color: var(--primary-green) !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .d-flex.flex-wrap.gap-2 {
            justify-content: center;
        }
        .px-3 {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        .table-responsive {
            border-radius: 1rem; /* Apply border-radius to the responsive wrapper */
            overflow: hidden; /* Hide overflowing content */
        }
        #servicebookingTable thead tr {
            font-size: 0.85rem;
        }
        #servicebookingTable td {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }
        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }
        .modal-dialog-centered {
            margin: 1rem;
        }
    }
</style>

<div class="container-fluid py-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 px-3">
        <h3 class="fw-bold mb-0" style="color:var(--secondary-black);"><i class="bi bi-calendar-check me-2"></i>Service Booking List</h3>
        <a href="{{ path('app_servicebooking_new') }}" class="btn btn-theme-primary"><i class="bi bi-plus-circle me-2"></i>Create New Booking</a>
    </div>

    <!-- Table -->
    <div class="card mx-1">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="servicebookingTable" class="table table-hover align-middle mb-0">
                    <thead>
                        <tr class="text-center">
                            <th class="fw-bold">ID</th>
                            <th class="fw-bold">Customer Name</th>
                            <th class="fw-bold">Service Type</th>
                            <th class="fw-bold">Adviser Category</th>
                            <th class="fw-bold">Preferred Date</th>
                            <th class="fw-bold">Notes</th>
                            <th class="fw-bold">Created At</th>
                            <th class="fw-bold">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for servicebooking in servicebookings %}
                        <tr>
                            <td class="text-center">{{ servicebooking.id }}</td>
                            <td class="text-start">{{ servicebooking.customername }}</td> {# Left align customer name #}
                            <td class="text-center">{{ servicebooking.serviceType }}</td>
                            <td class="text-center">{{ servicebooking.advisercategory }}</td>
                            <td class="text-center">{{ servicebooking.preferredDate ? servicebooking.preferredDate|date('Y-m-d H:i') : '' }}</td>
                            <td class="text-start text-truncate" style="max-width: 150px;">{{ servicebooking.notes ?? 'No notes' }}</td> {# Truncate long notes #}
                            <td class="text-center">{{ servicebooking.getCreatedAt() ? servicebooking.getCreatedAt()|date('Y-m-d H:i') : '' }}</td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                    <button type="button"
                                            class="btn btn-sm btn-theme-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#showModal{{ servicebooking.id }}">
                                        <i class="bi bi-eye"></i> Show
                                    </button>

                                    <button type="button"
                                            class="btn btn-sm btn-theme-secondary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal{{ servicebooking.id }}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>

                                    {{ include('servicebooking/_delete_form.html.twig', { servicebooking : servicebooking }) }}
                                </div>
                            </td>
                        </tr>

                        <!-- SHOW MODAL -->
                        <div class="modal fade" id="showModal{{ servicebooking.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Booking #{{ servicebooking.id }} Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Customer Name:</strong> {{ servicebooking.customername }}</li>
                                            <li><strong>Service Type:</strong> {{ servicebooking.serviceType }}</li>
                                            <li><strong>Adviser Category:</strong> {{ servicebooking.advisercategory }}</li>
                                            <li><strong>Preferred Date:</strong> {{ servicebooking.preferredDate ? servicebooking.preferredDate|date('Y-m-d H:i') : 'N/A' }}</li>
                                            <li><strong>Notes:</strong> {{ servicebooking.notes ?? 'No notes' }}</li>
                                            <li><strong>Created At:</strong> {{ servicebooking.getCreatedAt() ? servicebooking.getCreatedAt()|date('Y-m-d H:i') : 'N/A' }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EDIT MODAL -->
                        <div class="modal fade" id="editModal{{ servicebooking.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Booking #{{ servicebooking.id }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body p-4" id="editModalBody{{ servicebooking.id }}">
                                        <div class="text-center text-muted py-3">
                                            <div class="spinner-border" role="status"></div>
                                            <p class="mt-2 mb-0 small">Loading form...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">No service bookings found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dynamically load edit form into modal
    document.querySelectorAll('[id^="editModal"]').forEach(modalEl => {
        modalEl.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const servicebookingId = button.getAttribute('data-bs-target').replace('#editModal', '');
            const modalBody = document.getElementById(`editModalBody${servicebookingId}`);

            // Clear previous content and show spinner
            modalBody.innerHTML = `
                <div class="text-center text-muted py-3">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2 mb-0 small">Loading form...</p>
                </div>
            `;

            // Fetch the form
            fetch(`/servicebooking/${servicebookingId}/edit_form`) // Adjust this URL to your controller's route for fetching the form
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(html => {
                    modalBody.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading the edit form:', error);
                    modalBody.innerHTML = `<p class="text-danger">Failed to load edit form. Please try again.</p>`;
                });
        });
    });
});
</script>
{% endblock %}

{% endblock %}